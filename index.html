<!DOCTYPE html>
<html>

<head>
    <title>Pixel Calc</title>
    <style type="text/css">
        canvas#canvas {
            height: 400px;
            width: 400px;
            border: 1px solid gray;
            margin-right: 20px;
            margin-bottom: 5ex;
        }

        textarea#input {
            width: 800px;
            min-height: 20ex;
        }

        textarea#input.busy {
            background-color: lightgray;
        }

        #error {
            color: rgb(200, 0, 0);
            min-width: 400px;
            vertical-align: top;
            padding-left: 30px
        }
    </style>

    <script type="application/javascript">
        function run() {
            const input = document.getElementById("input");
            input.classList.add("busy");
            const newCode = input.value;

            const errorDiv = document.getElementById("error");
            errorDiv.innerHTML = "";

            let redValue = 0;
            let greenValue = 0;
            let blueValue = 0;
            const red = (v) => {
                redValue = v;
            }
            const green = (v) => {
                greenValue = v;
            }
            const blue = (v) => {
                blueValue = v;
            }
            const roll = (v) => v % 100;
            const reflect = (v) => {
                while (v < 0) {
                    v += 200;
                }
                v = v % 200;
                if (v > 100) {
                    const over = v - 100;
                    v = 100 - over;
                }
                return v;
            }
            const getColor = () => {
                const [r, g, b] = [redValue, greenValue, blueValue].map(c => {
                    const pct = c > 100 ? 100 : c < 0 ? 0 : c;
                    const value = parseInt(Math.round(255 * (pct / 100)));
                    if (value < 0) {
                        return 0;
                    } else if (value > 255) {
                        return 255;
                    }
                    return value;
                });
                return `rgb(${r}, ${g}, ${b})`;
            }

            let i;
            let j;
            let x;
            let y;

            try {
                const func = new Function("x", "y", "red", "green", "blue", "roll", "reflect", "i", "w", "j", "h", newCode);

                const canvas = document.getElementById("canvas");
                const width = canvas.width;
                const height = canvas.height;
                const ctx = canvas.getContext("2d");
                ctx.clearRect(0, 0, width, height);
                for (i = 0; i < width; i++) {
                    x = 100 * i / (width - 1);
                    for (j = 0; j < height; j++) {
                        y = 100 * j / (height - 1);
                        redValue = 0;
                        blueValue = 0;
                        greenValue = 0;
                        func(x, y, red, green, blue, roll, reflect, i, width, j, height);
                        ctx.fillStyle = getColor();
                        ctx.fillRect(i, j, 1, 1);
                    }
                }
            } catch (error) {
                const title = document.createElement("h3");
                title.appendChild(document.createTextNode("Error running code:"))
                errorDiv.appendChild(title);
                errorDiv.appendChild(document.createTextNode(`x = ${Math.round(x)}`))
                errorDiv.appendChild(document.createElement("br"));
                errorDiv.appendChild(document.createTextNode(`y = ${Math.round(y)}`))
                errorDiv.appendChild(document.createElement("br"));
                const subtitle = document.createElement("h4");
                subtitle.appendChild(document.createTextNode("Error:"));
                errorDiv.appendChild(subtitle);
                errorDiv.appendChild(document.createTextNode(error));
                console.error(error);
            }
            input.classList.remove("busy");
        }
    </script>
</head>

<body onload="javascript:run()">
    <table>
        <tbody>
            <tr>
                <td>
                    <canvas id="canvas" width="600" height="600"></canvas>
                </td>
                <td style="vertical-align: top">
                    <p>
                        Write your code in the box below. Your code will set the color
                        of each pixel in the image to the left.
                    </p>

                    <p>
                        Use the <em>functions</em> called <code>red()</code>, <code>blue()</code>,
                        and <code>green()</code> to mix the color for the pixel. For instance,
                        <code>red(100)</code> mixes in the maximum amount of red (100%).
                        Using <code>red(100)</code> and <code>blue(100)</code> will mix maximum
                        amounts of red <em>and</em> blue, so you'll get a bright purple color.
                    </p>
                    <p>
                        You have some <em>variables</em> you can use in your code as well:
                    <ul>
                        <li><strong><code>x</code></strong>: The horizontal (left-right) position of the pixel.
                            All the way to the left, <code>x</code> is 0. All the way to the right, <code>x</code>
                            is equal to <code>100</code>.
                        </li>
                        <li><strong><code>y</code></strong>: The vertical (up-down) position of the pixel.
                            All the way at the top, <code>y</code> is 0. All the way at the bottom, <code>y</code>
                            is equal to <code>100</code>.
                        </li>
                    </ul>
                    </p>
                    <p>
                        You can add values together with <code>+</code>, and subtract values with <code>-</code>.
                        To muliply values use <code>*</code>. and to divide use <code>/</code>.
                        You can also use parenthesis to control the order of operations.
                    </p>
                </td>
                <td style="vertical-align: top; padding-left: 3em">
                    <p>
                        Here are some example snippets:
                    </p>
                    <p>
                        Make everything cyan (blue + green):
                    <pre>
blue(100)
green(100)
                    </pre>
                    </p>
                    <p>
                        Make everything grey:
                    <pre>
red(50)
blue(50)
green(50)
                    </pre>
                    <p>
                        Make the red component increase going from left to right:
                    <pre>
red(x)
                    </pre>
                    </p>
                    <p>
                        Make three green stripes:
                    <pre>
green(roll( 3 * x ))
                        </pre>
                    </p>
                    <p>
                        Make a different kind of blue strip
                    <pre>
blue(reflect( 5 * x ))
                        </pre>
                    </p>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <pre>
function colorPixel(x, y, red, green, blue, roll, reflect, i, w, j, h) {
    <textarea id="input" data-enable-grammarly="false" data-gramm_editor="false" data-gramm="false" spellcheck="false">
red(x)
green(y)
    </textarea>
}
                    </pre>
                    <br />
                    <button id="run-button" onclick="javascript:run()">Run</button>
                </td>
                <td id="error">
                </td>
            </tr>
        </tbody>
    </table>
</body>

</html>